# R-data.table
R data.table的简单教程

1. data.table的安装和载入
```r
install.packages("data.table")  # 安装data.table库
library(data.table)             # 装载data.table库
```

2. 创建data.table
```r
# 创建一个三列的data.table，每列的名字分别是COL1，COL2，COL3
# 每列的值都是1:3，也就是1到3的整数
dt1 = data.table(COL1=1:3, COL2=1:3, COL3=1:3)

# 输出表格
print(dt1)
#    COL1 COL2 COL3
# 1:    1    1    1
# 2:    2    2    2
# 3:    3    3    3

# 再创建一个三列的data.table，每列的名字分别是COL1，COL2，COL3
# COL1的值是1:2，COL2的值是1:4，COL3的值是1:8
dt2 = data.table(COL1=1:2, COL2=1:4, COL3=1:8)

# 输出表格
# 当每列的长度不同时，创建的data.table的行数和最长的一列相等
# 长度不够的列会循环复制
print(dt2)
#    COL1 COL2 COL3
# 1:    1    1    1
# 2:    2    2    2
# 3:    1    3    3
# 4:    2    4    4
# 5:    1    1    5
# 6:    2    2    6
# 7:    1    3    7
# 8:    2    4    8

# data.table中的列可以是任何数据类型，例如整数、随机数、字符串等
# 当最长的列不是其他列长度的整数倍时，会提示Warning message
set.seed(45)
dt3 = data.table(V1=c("张三", "李四", "王五"), V2=round(rnorm(6), 4), V3=LETTERS[1:4])
print(dt3)
#      V1      V2 V3
# 1: 张三  0.3408  A
# 2: 李四 -0.7033  B
# 3: 王五 -0.3795  C
# 4: 张三 -0.7460  D
# 5: 李四 -0.8981  A
# 6: 王五 -0.3348  B
```

3. 获取data.table的行
```r
dt3[1]                      # 第1行
dt3[c(3,5)]                 # 第3、5行
dt3[4:6]                    # 第4到6行
dt3[6:4]                    # 上面结果倒过来
dt3[V1=="张三"]             # 第一列为"张三"的行
dt3[V1!="李四"]             # 第一列不为"李四"的行
dt3[V2>0.3]                 # 第二列大于0.3的行
dt3[V2>-0.4 & V2<0]         # 第二列大于-0.4且小于0的行
dt3[V2<-0.4 | V2>0]         # 第二列小于-0.4或者大于0的行
dt3[V3 %in% c("A", "C")]    # 第三列为A或者C的行
dt3[!V3 %in% c("C", "D")]   # 第三列不为C和D的行
dt3[V3=="A" & V2<0]         # 第三列为A且第二列小于0的行
dt3[V3=="A"][V2<0]          # 同上
dt3[4:6][V3=="A"]           # 第4到6行中第三列为A的行
```

4. 获取data.table的列
```r
# 获取第1列（按数组输出，结果不再是data.table）
dt3[,V1]
# [1] "张三" "李四" "王五" "张三" "李四" "王五"

# 获取第1列（结果仍是data.table）
dt3[,.(V1)]
#      V1
# 1: 张三
# 2: 李四
# 3: 王五
# 4: 张三
# 5: 李四
# 6: 王五

# 但是，当获取多个列时，上面两种写法的结果都是data.table
# 注意：输出列的顺序不一样
dt3[,V1,V2]
#         V2   V1
# 1:  0.3408 张三
# 2: -0.7033 李四
# 3: -0.3795 王五
# 4: -0.7460 张三
# 5: -0.8981 李四
# 6: -0.3348 王五

dt3[,.(V1,V2)]
#      V1      V2
# 1: 张三  0.3408
# 2: 李四 -0.7033
# 3: 王五 -0.3795
# 4: 张三 -0.7460
# 5: 李四 -0.8981
# 6: 王五 -0.3348

# 获取V2列的平均值
dt3[,.(mean(V2)]
#            V1
# 1: -0.4534833

# 获取V2列的平均值、求和、方差，以及V3最大值
dt3[,.(mean(V2), sum(V2), sd(V2), max(V3))]
#            V1      V2        V3     V4
# 1: -0.4534833 -2.7209 0.4463415      D

# 注意到上面输出的列都是根据原来的列名字自动命名的（V1, V2, V3, V4）
# 如果要用别的列名，可以采用下面的写法
dt3[,.(average_V2=mean(V2), sumOfV2=sum(V2), variance.V2=sd(V2), maximum_of_V3=max(V3))]
#    average_V2 sumOfV2 variance.V2 maximum_of_V3
# 1: -0.4534833 -2.7209   0.4463415             D
```

5. 同时获取行和列的数据
```r
# 获取第2到5行的V2的平均值
dt3[2:5, .(average_V2=mean(V2))]
#    average_V2
# 1:  -0.681725

# 获取第1列为张三的行，V2的平均值
dt3[V1=="张三", .(average_V2=mean(V2))]
#    average_V2
# 1:    -0.2026

# 获取张三、李四、王五，各自的V2平均值
dt3[, .(average_V2=mean(V2)), by=V1]
#      V1 average_V2
# 1: 张三   -0.20260
# 2: 李四   -0.80070
# 3: 王五   -0.35715

# 获取第3列不同字母下，各自的V2平均值
dt3[, .(average_V2=mean(V2)), by=V3]
#    V3 average_V2
# 1:  A   -0.27865
# 2:  B   -0.51905
# 3:  C   -0.37950
# 4:  D   -0.74600

# 创建新的data.table
dt4 = data.table(V1=c("张三", "李四", "王五"), V2=round(rnorm(6), 4), V3=LETTERS[1:2])
dt4
#       V1      V2 V3
#  1: 张三 -0.5014  A
#  2: 李四 -0.1745  B
#  3: 王五  1.8090  A
#  4: 张三 -0.2301  B
#  5: 李四 -1.1304  A
#  6: 王五  0.2160  B
#  7: 张三  1.2322  A
#  8: 李四  1.6094  B
#  9: 王五  0.4016  A
# 10: 张三 -0.2730  B
# 11: 李四 -0.0362  A
# 12: 王五 -0.1503  B

# 更复杂的情况：或者各种不同的第1列和第3列组合下，各自的V2平均值
dt4[, .(average_V2=mean(V2)), by=.(V1,V3)]
#      V1 V3 average_V2
# 1: 张三  A    0.36540
# 2: 李四  B    0.71745
# 3: 王五  A    1.10530
# 4: 张三  B   -0.25155
# 5: 李四  A   -0.58330
# 6: 王五  B    0.03285

# 还想显示每种V1和V3组合的个数，用.N这个符号
dt4[, .(.N), by=.(V1,V3)]
#      V1 V3 N
# 1: 张三  A 2
# 2: 李四  B 2
# 3: 王五  A 2
# 4: 张三  B 2
# 5: 李四  A 2
# 6: 王五  B 2

# 上面两个例子组合在一起
dt4[, .(average_V2=mean(V2),size=.N), by=.(V1,V3)]
#      V1 V3 average_V2 size
# 1: 张三  A    0.36540    2
# 2: 李四  B    0.71745    2
# 3: 王五  A    1.10530    2
# 4: 张三  B   -0.25155    2
# 5: 李四  A   -0.58330    2
# 6: 王五  B    0.03285    2
```

6. 更新data.table中的数据
```r
# 修改单个元素：修改第1行第2列的值
dt3[1,2] = 0.435
dt3
#      V1      V2 V3
# 1: 张三  0.4350  A
# 2: 李四 -0.7033  B
# 3: 王五 -0.3795  C
# 4: 张三 -0.7460  D
# 5: 李四 -0.8981  A
# 6: 王五 -0.3348  B

# 修改整列：替换第3列的值为E到G
dt3[,V3:=LETTERS[5:7]]
dt3
#      V1      V2 V3
# 1: 张三  0.4350  E
# 2: 李四 -0.7033  F
# 3: 王五 -0.3795  G
# 4: 张三 -0.7460  E
# 5: 李四 -0.8981  F
# 6: 王五 -0.3348  G

# 修改整列：第2列的值都加1
dt3[,V2:=V2+1]
dt3
#      V1     V2 V3
# 1: 张三 1.4350  E
# 2: 李四 0.2967  F
# 3: 王五 0.6205  G
# 4: 张三 0.2540  E
# 5: 李四 0.1019  F
# 6: 王五 0.6652  G

# 修改整列：第2列的值取指数
dt3[,V2:=exp(V2)]
dt3
#      V1       V2 V3
# 1: 张三 4.199645  E
# 2: 李四 1.345412  F
# 3: 王五 1.859858  G
# 4: 张三 1.289172  E
# 5: 李四 1.107273  F
# 6: 王五 1.944879  G

# 同时修改多列
dt4[,c("V2","V3"):=list(exp(V2), LETTERS[4:6])]
dt4
#       V1        V2 V3
#  1: 张三 0.6056821  D
#  2: 李四 0.8398769  E
#  3: 王五 6.1043400  F
#  4: 张三 0.7944542  D
#  5: 李四 0.3229041  E
#  6: 王五 1.2411024  F
#  7: 张三 3.4287645  D
#  8: 李四 4.9998104  E
#  9: 王五 1.4942135  F
# 10: 张三 0.7610928  D
# 11: 李四 0.9644474  E
# 12: 王五 0.8604498  F

# 删除第3列
dt4[,V3:=NULL]
dt4
#       V1        V2
#  1: 张三 0.6056821
#  2: 李四 0.8398769
#  3: 王五 6.1043400
#  4: 张三 0.7944542
#  5: 李四 0.3229041
#  6: 王五 1.2411024
#  7: 张三 3.4287645
#  8: 李四 4.9998104
#  9: 王五 1.4942135
# 10: 张三 0.7610928
# 11: 李四 0.9644474
# 12: 王五 0.8604498
```
